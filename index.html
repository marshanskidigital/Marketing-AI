<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Marketing AI</title>
    <meta name="description" content="A beautiful dashboard displaying Google Ads campaign performance data." />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
        rel="stylesheet" />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>

    <style>
        /* â”€â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --bg-primary: #f0f2f5;
            --bg-secondary: #e8eaef;
            --bg-card: #ffffff;
            --bg-card-hover: #f7f8fc;
            --border: rgba(0, 0, 0, .08);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent-blue: #3b82f6;
            --accent-cyan: #0891b2;
            --accent-green: #059669;
            --accent-amber: #d97706;
            --accent-rose: #e11d48;
            --accent-violet: #7c3aed;
            --gradient-blue: linear-gradient(135deg, #3b82f6, #0891b2);
            --gradient-green: linear-gradient(135deg, #059669, #34d399);
            --gradient-amber: linear-gradient(135deg, #d97706, #fbbf24);
            --gradient-rose: linear-gradient(135deg, #e11d48, #fb7185);
            --radius-sm: 8px;
            --radius-md: 14px;
            --radius-lg: 20px;
            --shadow-card: 0 2px 12px rgba(0, 0, 0, .06);
            --sidebar-width: 72px;
            --sidebar-expanded: 240px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* â”€â”€â”€ Ambient glow blobs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        body::before,
        body::after {
            content: '';
            position: fixed;
            border-radius: 50%;
            filter: blur(120px);
            opacity: .08;
            pointer-events: none;
            z-index: 0;
        }

        body::before {
            width: 600px;
            height: 600px;
            background: var(--accent-blue);
            top: -180px;
            left: -120px;
        }

        body::after {
            width: 500px;
            height: 500px;
            background: var(--accent-violet);
            bottom: -100px;
            right: -80px;
        }

        /* â”€â”€â”€ App Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .app-layout {
            display: flex;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* â”€â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
            border-right: 1px solid rgba(255, 255, 255, .06);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            z-index: 100;
            transition: width .3s cubic-bezier(.4, 0, .2, 1);
            overflow: hidden;
        }

        .sidebar:hover {
            width: var(--sidebar-expanded);
        }

        .sidebar-logo {
            width: 40px;
            height: 40px;
            min-width: 40px;
            border-radius: 10px;
            background: var(--gradient-blue);
            display: grid;
            place-items: center;
            font-size: 18px;
            font-weight: 800;
            color: #fff;
            box-shadow: 0 0 24px rgba(59, 130, 246, .3);
            margin-bottom: 36px;
            cursor: pointer;
            transition: transform .2s;
        }

        .sidebar-logo:hover {
            transform: scale(1.08);
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 6px;
            width: 100%;
            padding: 0 12px;
            flex: 1;
        }

        .sidebar-btn {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px 14px;
            border: none;
            background: transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all .2s ease;
            color: rgba(255, 255, 255, .45);
            text-decoration: none;
            white-space: nowrap;
            font-family: 'Inter', sans-serif;
            font-size: .84rem;
            font-weight: 500;
            overflow: hidden;
        }

        .sidebar-btn:hover {
            background: rgba(255, 255, 255, .06);
            color: rgba(255, 255, 255, .8);
        }

        .sidebar-btn.active {
            background: rgba(59, 130, 246, .15);
            color: #fff;
            box-shadow: inset 0 0 0 1px rgba(59, 130, 246, .25);
        }

        .sidebar-btn .icon {
            width: 22px;
            min-width: 22px;
            height: 22px;
            display: grid;
            place-items: center;
            font-size: 18px;
            line-height: 1;
        }

        .sidebar-btn .label {
            opacity: 0;
            transition: opacity .2s ease;
        }

        .sidebar:hover .sidebar-btn .label {
            opacity: 1;
        }

        .sidebar-divider {
            width: calc(100% - 24px);
            height: 1px;
            background: rgba(255, 255, 255, .06);
            margin: 12px 12px;
        }

        /* â”€â”€â”€ Main Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            transition: margin-left .3s cubic-bezier(.4, 0, .2, 1);
        }

        /* â”€â”€â”€ Page containers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* â”€â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .dashboard {
            position: relative;
            z-index: 1;
            max-width: 1360px;
            margin: 0 auto;
            padding: 32px 28px 60px;
        }

        /* â”€â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 36px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .logo-icon {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-sm);
            background: var(--gradient-blue);
            display: grid;
            place-items: center;
            font-size: 20px;
            font-weight: 800;
            color: #fff;
            box-shadow: 0 0 20px rgba(59, 130, 246, .25);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -.02em;
        }

        .header h1 span {
            color: var(--accent-cyan);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* â”€â”€â”€ Account Filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .account-filter {
            font-family: 'Inter', sans-serif;
            font-size: .82rem;
            color: var(--text-primary);
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 8px 38px 8px 14px;
            border-radius: 100px;
            cursor: pointer;
            outline: none;
            transition: border-color .2s;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6' viewBox='0 0 10 6'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%2364748b' stroke-width='1.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
        }

        .account-filter:hover,
        .account-filter:focus {
            border-color: var(--accent-cyan);
        }

        .account-filter option {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .date-badge {
            font-size: .82rem;
            color: var(--text-secondary);
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 8px 18px;
            border-radius: 100px;
        }

        /* â”€â”€â”€ KPI Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .kpi-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: transform .25s, box-shadow .25s;
            box-shadow: var(--shadow-card);
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, .1);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
        }

        .kpi-card:nth-child(1)::before {
            background: var(--gradient-blue);
        }

        .kpi-card:nth-child(2)::before {
            background: var(--gradient-green);
        }

        .kpi-card:nth-child(3)::before {
            background: var(--gradient-amber);
        }

        .kpi-card:nth-child(4)::before {
            background: var(--gradient-rose);
        }

        .kpi-label {
            font-size: .78rem;
            text-transform: uppercase;
            letter-spacing: .08em;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .kpi-value {
            font-size: 1.9rem;
            font-weight: 800;
            letter-spacing: -.03em;
        }

        .kpi-sub {
            font-size: .78rem;
            font-weight: 500;
            margin-top: 8px;
            color: var(--text-secondary);
        }

        .kpi-sub .live-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-green);
            margin-right: 4px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .3;
            }
        }

        /* â”€â”€â”€ Charts row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .charts-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 32px;
        }

        @media (max-width: 900px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 24px;
            box-shadow: var(--shadow-card);
        }

        .card-title {
            font-size: .92rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .chart-wrapper {
            position: relative;
            width: 100%;
            height: 300px;
        }

        .chart-wrapper canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* â”€â”€â”€ Campaign Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .table-card {
            overflow: hidden;
        }

        .table-scroll {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 760px;
        }

        thead th {
            text-align: left;
            font-size: .75rem;
            text-transform: uppercase;
            letter-spacing: .07em;
            color: var(--text-secondary);
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
            transition: color .2s;
        }

        thead th:hover {
            color: var(--text-primary);
        }

        thead th .sort-arrow {
            margin-left: 4px;
            font-size: .65rem;
        }

        tbody td {
            padding: 14px 16px;
            font-size: .86rem;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        tbody tr {
            transition: background .2s;
        }

        tbody tr:hover {
            background: var(--bg-card-hover);
        }

        .campaign-name {
            font-weight: 600;
            max-width: 280px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .account-tag {
            display: block;
            font-size: .68rem;
            font-weight: 400;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 12px;
            border-radius: 100px;
            font-size: .72rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .04em;
        }

        .status-badge.enabled {
            background: rgba(5, 150, 105, .1);
            color: var(--accent-green);
        }

        .status-badge.paused {
            background: rgba(217, 119, 6, .1);
            color: var(--accent-amber);
        }

        .status-badge.removed {
            background: rgba(100, 116, 139, .1);
            color: var(--text-secondary);
        }

        .channel-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 100px;
            font-size: .68rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .03em;
            background: rgba(59, 130, 246, .08);
            color: var(--accent-blue);
        }

        /* â”€â”€â”€ Loading state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .loading-overlay {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 80px 20px;
            gap: 20px;
        }

        .spinner {
            width: 44px;
            height: 44px;
            border: 3px solid var(--border);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin .7s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-size: .88rem;
            color: var(--text-secondary);
        }

        .error-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--accent-rose);
            font-size: .92rem;
        }

        .error-state .retry-btn {
            display: inline-block;
            margin-top: 16px;
            padding: 10px 24px;
            background: var(--gradient-blue);
            color: #fff;
            border: none;
            border-radius: 100px;
            font-family: 'Inter', sans-serif;
            font-size: .84rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity .2s;
        }

        .error-state .retry-btn:hover {
            opacity: .85;
        }

        /* â”€â”€â”€ Fade-in animation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .fade-up {
            opacity: 0;
            transform: translateY(18px);
            animation: fadeUp .55s ease forwards;
        }

        @keyframes fadeUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .delay-1 {
            animation-delay: .08s;
        }

        .delay-2 {
            animation-delay: .16s;
        }

        .delay-3 {
            animation-delay: .24s;
        }

        .delay-4 {
            animation-delay: .32s;
        }

        .delay-5 {
            animation-delay: .40s;
        }

        .delay-6 {
            animation-delay: .48s;
        }

        /* â”€â”€â”€ AI Chat Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .chat-page {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 900px;
            margin: 0 auto;
            padding: 0 24px;
        }

        /* â”€â”€â”€ Chat Theme Colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        /* Theme 1: Euroline (Blue) */
        .chat-page.theme-tab1 {
            --chat-primary: #3b82f6;
            --chat-primary-hover: #2563eb;
            --chat-gradient: linear-gradient(135deg, #3b82f6, #2563eb);
            --chat-shadow: rgba(59, 130, 246, .25);
        }

        /* Theme 2: Floor&Care (Violet/Indigo) */
        .chat-page.theme-tab2 {
            --chat-primary: #8b5cf6;
            --chat-primary-hover: #7c3aed;
            --chat-gradient: linear-gradient(135deg, #8b5cf6, #7c3aed);
            --chat-shadow: rgba(139, 92, 246, .25);
        }

        /* Theme 3: Marshanski Build (Emerald) */
        .chat-page.theme-tab3 {
            --chat-primary: #10b981;
            --chat-primary-hover: #059669;
            --chat-gradient: linear-gradient(135deg, #10b981, #059669);
            --chat-shadow: rgba(16, 185, 129, .25);
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 28px 0 20px;
            flex-shrink: 0;
        }

        .chat-avatar {
            width: 48px;
            height: 48px;
            min-width: 48px;
            border-radius: 14px;
            background: linear-gradient(135deg, #d97706, #f59e0b);
            display: grid;
            place-items: center;
            font-size: 22px;
            color: #fff;
            box-shadow: 0 0 20px rgba(217, 119, 6, .2);
        }

        .chat-header-info h2 {
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: -.01em;
        }

        .chat-header-info p {
            font-size: .8rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .chat-header-info .status-online {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .chat-header-info .status-online::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--accent-green);
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* â”€â”€â”€ Chat Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .chat-tabs {
            display: flex;
            gap: 8px;
            padding: 10px 0 16px 0;
            flex-shrink: 0;
            overflow-x: auto;
        }

        .chat-tabs::-webkit-scrollbar {
            height: 0px;
        }

        .chat-tab-btn {
            position: relative;
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            border-radius: 100px;
            font-family: 'Inter', sans-serif;
            font-size: .84rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all .2s;
            white-space: nowrap;
            font-weight: 500;
        }

        .unread-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: var(--accent-rose);
            color: white;
            font-size: 10px;
            font-weight: bold;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            animation: bounceIn .3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes bounceIn {
            0% {
                transform: scale(0);
            }

            100% {
                transform: scale(1);
            }
        }

        .chat-tab-btn:hover {
            border-color: var(--chat-primary, var(--accent-blue));
            color: var(--chat-primary, var(--accent-blue));
        }

        .chat-tab-btn.active {
            background: var(--chat-primary, var(--accent-blue));
            color: #fff;
            border-color: var(--chat-primary, var(--accent-blue));
            box-shadow: 0 4px 12px var(--chat-shadow, rgba(59, 130, 246, .25));
        }

        /* â”€â”€â”€ Messages Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 28px 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
            scroll-behavior: smooth;
        }

        .chat-messages::-webkit-scrollbar {
            width: 5px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, .1);
            border-radius: 10px;
        }

        .msg {
            display: flex;
            gap: 12px;
            max-width: 82%;
            animation: msgIn .35s ease forwards;
            scroll-margin-top: 40px;
        }

        @keyframes msgIn {
            from {
                opacity: 0;
                transform: translateY(12px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .msg.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .msg-avatar {
            width: 34px;
            height: 34px;
            min-width: 34px;
            border-radius: 10px;
            display: grid;
            place-items: center;
            font-size: 14px;
            font-weight: 700;
            color: #fff;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .msg.ai .msg-avatar {
            background: linear-gradient(135deg, #d97706, #f59e0b);
        }

        .msg.user .msg-avatar {
            background: var(--chat-gradient, var(--gradient-blue));
        }

        .msg-bubble {
            padding: 14px 18px;
            border-radius: 18px;
            font-size: .88rem;
            line-height: 1.65;
            position: relative;
        }

        .msg.ai .msg-bubble {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-top-left-radius: 4px;
            box-shadow: var(--shadow-card);
            color: var(--text-primary);
            direction: rtl;
            text-align: right;
        }

        .msg.user .msg-bubble {
            background: var(--chat-gradient, linear-gradient(135deg, #3b82f6, #2563eb));
            color: #fff;
            border-top-right-radius: 4px;
            box-shadow: 0 4px 16px var(--chat-shadow, rgba(59, 130, 246, .25));
        }

        .msg-time {
            font-size: .68rem;
            color: var(--text-secondary);
            margin-top: 6px;
            padding: 0 4px;
        }

        .msg.user .msg-time {
            text-align: right;
        }

        /* â”€â”€â”€ AI Response Markdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .msg.ai .msg-bubble p {
            margin-bottom: 8px;
        }

        .msg.ai .msg-bubble p:last-child {
            margin-bottom: 0;
        }

        .msg.ai .msg-bubble strong {
            font-weight: 700;
            color: var(--text-primary);
        }

        .msg.ai .msg-bubble em {
            font-style: italic;
        }

        .msg.ai .msg-bubble code {
            background: rgba(0, 0, 0, .06);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: .82rem;
            font-family: 'Courier New', monospace;
        }

        .msg.ai .msg-bubble pre {
            background: #0f172a;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 10px;
            overflow-x: auto;
            margin: 10px 0;
            font-size: .8rem;
            line-height: 1.5;
        }

        .msg.ai .msg-bubble pre code {
            background: none;
            padding: 0;
            color: inherit;
            font-size: inherit;
        }

        .msg.ai .msg-bubble ul,
        .msg.ai .msg-bubble ol {
            padding-right: 20px;
            padding-left: 0;
            margin: 8px 0;
        }

        .msg.ai .msg-bubble li {
            margin-bottom: 4px;
        }

        /* â”€â”€â”€ Typing Indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .typing-indicator {
            display: none;
            align-self: flex-start;
            gap: 12px;
            max-width: 82%;
        }

        .typing-indicator.visible {
            display: flex;
        }

        .typing-dots {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 16px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 18px;
            border-top-left-radius: 4px;
            box-shadow: var(--shadow-card);
        }

        .typing-dots span {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--text-secondary);
            animation: typingBounce 1.2s ease-in-out infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: .15s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: .3s;
        }

        @keyframes typingBounce {

            0%,
            60%,
            100% {
                transform: translateY(0);
                opacity: .4;
            }

            30% {
                transform: translateY(-6px);
                opacity: 1;
            }
        }

        /* â”€â”€â”€ Chat Input â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .chat-input-area {
            flex-shrink: 0;
            padding: 16px 0 28px;
        }

        .chat-input-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 8px 8px 8px 20px;
            box-shadow: var(--shadow-card);
            transition: border-color .2s, box-shadow .2s;
        }

        .chat-input-wrapper:focus-within {
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, .08), var(--shadow-card);
        }

        .chat-input {
            flex: 1;
            border: none;
            outline: none;
            font-family: 'Inter', sans-serif;
            font-size: .88rem;
            color: var(--text-primary);
            background: transparent;
            resize: none;
            max-height: 140px;
            line-height: 1.5;
            padding: 8px 0;
        }

        .chat-input::placeholder {
            color: var(--text-secondary);
        }

        .chat-send-btn {
            width: 42px;
            height: 42px;
            min-width: 42px;
            border: none;
            border-radius: 12px;
            background: var(--chat-gradient, var(--gradient-blue));
            color: #fff;
            cursor: pointer;
            display: grid;
            place-items: center;
            font-size: 18px;
            transition: transform .15s, opacity .15s;
            box-shadow: 0 2px 10px var(--chat-shadow, rgba(59, 130, 246, .25));
        }

        .chat-send-btn:hover {
            transform: scale(1.06);
        }

        .chat-send-btn:active {
            transform: scale(.95);
        }

        .chat-send-btn:disabled {
            opacity: .5;
            cursor: not-allowed;
            transform: none;
        }

        .chat-hint {
            font-size: .72rem;
            color: var(--text-secondary);
            margin-top: 8px;
            text-align: center;
        }

        /* â”€â”€â”€ Welcome Message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .chat-welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            gap: 16px;
            text-align: center;
            padding: 40px 20px;
        }

        .chat-welcome-icon {
            width: 72px;
            height: 72px;
            border-radius: 20px;
            background: linear-gradient(135deg, #d97706, #f59e0b);
            display: grid;
            place-items: center;
            font-size: 34px;
            color: #fff;
            box-shadow: 0 8px 32px rgba(217, 119, 6, .2);
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-8px);
            }
        }

        .chat-welcome h3 {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .chat-welcome p {
            font-size: .88rem;
            color: var(--text-secondary);
            max-width: 420px;
            line-height: 1.6;
        }

        .chat-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-top: 8px;
        }

        .chat-suggestion-btn {
            padding: 8px 16px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            border-radius: 100px;
            font-family: 'Inter', sans-serif;
            font-size: .78rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all .2s;
        }

        .chat-suggestion-btn:hover {
            border-color: var(--chat-primary, var(--accent-blue));
            color: var(--chat-primary, var(--accent-blue));
            background: rgba(59, 130, 246, .04);
            /* fallback opacity */
            box-shadow: inset 0 0 0 1px var(--chat-primary, transparent);
        }

        /* â”€â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 768px) {
            .sidebar {
                width: 56px;
            }

            .sidebar:hover {
                width: 56px;
            }

            .sidebar-btn .label {
                display: none;
            }

            .main-content {
                margin-left: 56px;
            }

            .chat-page {
                padding: 0 14px;
            }

            .msg {
                max-width: 92%;
            }
        }
    </style>
</head>

<body>

    <div class="app-layout">

        <!-- â”€â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo" onclick="switchPage('dashboard')">M</div>

            <nav class="sidebar-nav">
                <button class="sidebar-btn active" id="nav-dashboard" onclick="switchPage('dashboard')">
                    <span class="icon">ğŸ“Š</span>
                    <span class="label">Dashboard</span>
                </button>
                <button class="sidebar-btn" id="nav-ai-chat" onclick="switchPage('ai-chat')">
                    <span class="icon">ğŸ¤–</span>
                    <span class="label">AI Chat</span>
                </button>
            </nav>
        </aside>

        <!-- â”€â”€â”€ Main Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
        <div class="main-content">

            <!-- â•â•â• Dashboard Page â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="page active" id="page-dashboard">
                <div class="dashboard">

                    <!-- Header -->
                    <header class="header fade-up">
                        <div class="header-left">
                            <div class="logo-icon">M</div>
                            <h1>Marketing <span>AI</span></h1>
                        </div>
                        <div class="header-right">
                            <select class="account-filter" id="accountFilter">
                                <option value="all">All Accounts</option>
                            </select>
                            <div class="date-badge" id="dateRange">Loadingâ€¦</div>
                        </div>
                    </header>

                    <!-- KPI Cards -->
                    <section class="kpi-grid" id="kpiGrid"></section>

                    <!-- Charts -->
                    <section class="charts-row">
                        <div class="card fade-up delay-5">
                            <div class="card-title"><span class="dot" style="background:var(--accent-cyan)"></span>
                                Spend by Account
                            </div>
                            <div class="chart-wrapper"><canvas id="barChart"></canvas></div>
                        </div>
                        <div class="card fade-up delay-6">
                            <div class="card-title"><span class="dot" style="background:var(--accent-violet)"></span>
                                Spend by
                                Campaign</div>
                            <div class="chart-wrapper"><canvas id="doughnutChart"></canvas></div>
                        </div>
                    </section>

                    <!-- Campaign Table -->
                    <div class="card table-card fade-up delay-6">
                        <div class="card-title"><span class="dot" style="background:var(--accent-green)"></span>
                            Campaign
                            Performance</div>
                        <div class="table-scroll">
                            <table>
                                <thead>
                                    <tr>
                                        <th data-sort="campaign_name">Campaign <span class="sort-arrow"></span></th>
                                        <th data-sort="campaign_status">Status <span class="sort-arrow"></span></th>
                                        <th data-sort="channel_type">Channel <span class="sort-arrow"></span></th>
                                        <th data-sort="cost">Spend <span class="sort-arrow"></span></th>
                                        <th data-sort="impressions">Impressions <span class="sort-arrow"></span></th>
                                        <th data-sort="clicks">Clicks <span class="sort-arrow"></span></th>
                                        <th data-sort="ctr">CTR <span class="sort-arrow"></span></th>
                                        <th data-sort="cpc">CPC <span class="sort-arrow"></span></th>
                                        <th data-sort="conversions">Conversions <span class="sort-arrow"></span></th>
                                        <th data-sort="costConv">Cost / Conv <span class="sort-arrow"></span></th>
                                    </tr>
                                </thead>
                                <tbody id="campaignBody">
                                    <tr>
                                        <td colspan="10">
                                            <div class="loading-overlay">
                                                <div class="spinner"></div>
                                                <div class="loading-text">Fetching campaign dataâ€¦</div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>

            <!-- â•â•â• AI Chat Page â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div class="page" id="page-ai-chat">
                <div class="chat-page theme-tab1" id="chatPageContainer">

                    <!-- Chat Header -->
                    <div class="chat-header fade-up">
                        <div class="chat-avatar">ğŸ¤–</div>
                        <div class="chat-header-info">
                            <h2>Claude AI Assistant</h2>
                            <p><span class="status-online">Online</span> Â· Marketing strategy & insights</p>
                        </div>
                    </div>

                    <!-- Chat Tabs -->
                    <div class="chat-tabs fade-up delay-1" id="chatTabs">
                        <button class="chat-tab-btn active" onclick="switchChatTab('tab1')">Euroline</button>
                        <button class="chat-tab-btn" onclick="switchChatTab('tab2')">Floor&Care</button>
                        <button class="chat-tab-btn" onclick="switchChatTab('tab3')">Marshanski Build</button>
                    </div>

                    <!-- Messages -->
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-welcome" id="chatWelcome">
                            <div class="chat-welcome-icon">ğŸ¤–</div>
                            <h3>×¦'××˜ ×¢× Claude AI</h3>
                            <p>×©××œ×• ××•×ª×™ ×›×œ ×“×‘×¨ ×¢×œ ×§××¤×™×™× ×™× ×©×™×•×•×§×™×™×, ××¡×˜×¨×˜×’×™×™×ª ×¤×¨×¡×•×, × ×™×ª×•×— ×‘×™×¦×•×¢×™× ××• ×¨×¢×™×•× ×•×ª ×œ×¦××™×—×”.
                                ×× ×™ ×›××Ÿ ×œ×¢×–×•×¨!</p>
                            <div class="chat-suggestions">
                                <button class="chat-suggestion-btn"
                                    onclick="useSuggestion('× ×ª×— ××ª ×‘×™×¦×•×¢×™ ×”×¤×¨×¡×•× ×©×œ×™')">ğŸ“ˆ × ×™×ª×•×— ×‘×™×¦×•×¢×™ ×¤×¨×¡×•×</button>
                                <button class="chat-suggestion-btn"
                                    onclick="useSuggestion('×”×¦×¢ ××¡×˜×¨×˜×’×™×•×ª ×œ××•×¤×˜×™××™×–×¦×™×” ×©×œ ×ª×§×¦×™×‘')">ğŸ’° ××•×¤×˜×™××™×–×¦×™×™×ª
                                    ×ª×§×¦×™×‘</button>
                                <button class="chat-suggestion-btn"
                                    onclick="useSuggestion('×›×ª×•×‘ ×œ×™ ×§×•×¤×™ ×¤×¨×¡×•××™ ××©×›× ×¢ ×œ×§××¤×™×™×Ÿ ×œ×™×“×™×')">âœï¸ ×›×ª×™×‘×ª
                                    ×§×•×¤×™</button>
                                <button class="chat-suggestion-btn"
                                    onclick="useSuggestion('××”×Ÿ ×©×™×˜×•×ª ×”×¢×‘×•×“×” ×”××•××œ×¦×•×ª ×‘×’×•×’×œ ××“×¡ ×‘-2026?')">ğŸš€ ×©×™×˜×•×ª
                                    ××•××œ×¦×•×ª</button>
                            </div>
                        </div>
                    </div>

                    <!-- Typing Indicator -->
                    <div class="typing-indicator" id="typingIndicator">
                        <div class="msg-avatar" style="background: linear-gradient(135deg, #d97706, #f59e0b);">ğŸ¤–
                        </div>
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="chat-input-area">
                        <div class="chat-input-wrapper">
                            <textarea class="chat-input" id="chatInput" rows="1"
                                placeholder="×©××œ×• ××ª Claude ×›×œ ×“×‘×¨ ×¢×œ ×©×™×•×•×§..."
                                onkeydown="handleChatKeydown(event)"></textarea>
                            <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">
                                â¤
                            </button>
                        </div>
                        <div class="chat-hint">Enter ×œ×©×œ×™×—×” Â· Shift + Enter ×œ×©×•×¨×” ×—×“×©×”</div>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <script>
        /* â”€â”€â”€â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        const API_BASE = 'https://google-ads-api-44988665320.me-west1.run.app';

        /* â”€â”€â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        let allRows = [];
        let activeCampaigns = [];
        let currentAccount = 'all';
        let sortKey = 'cost';
        let sortDir = -1; // -1 = desc
        let barChartInstance = null;
        let doughnutChartInstance = null;

        // Chat state
        let activeChatTab = 'tab1';
        let chatHistories = {
            'tab1': [],
            'tab2': [],
            'tab3': []
        };
        // Generate UUIDs for each tab conversation
        const generateUUID = () => crypto.randomUUID ? crypto.randomUUID() : 'id-' + Math.random().toString(36).substr(2, 9);
        let chatConversationIds = {
            'tab1': generateUUID(),
            'tab2': generateUUID(),
            'tab3': generateUUID()
        };
        const chatProperties = {
            'tab1': '513346981', // Euroline
            'tab2': '399938286', // Floor&Care
            'tab3': '274079753'  // Marshanski Build
        };
        const chatGoogleAdsIds = {
            'tab1': '4283707037',  // Euroline
            'tab2': '1777445560',  // Floor&Care
            'tab3': '2824213105'   // Marshanski Build
        };
        const chatGscUrls = {
            'tab1': 'https://euroline.co.il/',
            'tab2': 'http://f-care.co.il/',
            'tab3': 'https://marshanski.com/'
        };
        const chatGtmAccountIds = {
            'tab1': '4702496311', // Euroline
            'tab2': '6001372225', // Floor&Care
            'tab3': '6330298232'  // Marshanski Build
        };
        const chatGtmPublicIds = {
            'tab1': 'GTM-NCJ9SK9Z', // Euroline
            'tab2': 'GTM-KBJBDZH',  // Floor&Care
            'tab3': 'GTM-WHRJSH35'   // Marshanski Build
        };


        /* â”€â”€â”€â”€â”€ Page Switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function switchPage(page) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            // Deactivate all nav buttons
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));

            // Show selected page & activate nav button
            document.getElementById(`page-${page}`).classList.add('active');
            document.getElementById(`nav-${page}`).classList.add('active');
        }

        /* â”€â”€â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        const fmt = n => n.toLocaleString('en-US');
        const fmtC = n => 'â‚ª' + n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const statusClass = s => s === 'ENABLED' ? 'enabled' : s === 'PAUSED' ? 'paused' : 'removed';

        /* â”€â”€â”€â”€â”€ Fetch data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        async function fetchData() {
            try {
                const res = await fetch(`${API_BASE}/campaigns`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                allRows = data.rows || [];
                activeCampaigns = allRows.filter(r => r.cost > 0);

                // Populate account filter
                const accounts = [...new Set(allRows.map(r => r.customer_name))].sort();
                const select = document.getElementById('accountFilter');
                accounts.forEach(name => {
                    const opt = document.createElement('option');
                    opt.value = name;
                    opt.textContent = name;
                    select.appendChild(opt);
                });

                // Set date badge
                document.getElementById('dateRange').textContent =
                    `${data.accounts_count} accounts Â· ${data.row_count} campaigns`;

                render();
            } catch (err) {
                console.error('Failed to fetch:', err);
                showError(err.message);
            }
        }

        function showError(msg) {
            document.getElementById('kpiGrid').innerHTML = '';
            document.getElementById('campaignBody').innerHTML = `
    <tr><td colspan="10">
      <div class="error-state">
        <div>âš ï¸ Failed to load data: ${msg}</div>
        <button class="retry-btn" onclick="location.reload()">Retry</button>
      </div>
    </td></tr>`;
        }

        /* â”€â”€â”€â”€â”€ Render everything â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function render() {
            const filtered = currentAccount === 'all'
                ? activeCampaigns
                : activeCampaigns.filter(r => r.customer_name === currentAccount);

            renderKPIs(filtered);
            renderTable(filtered);
            renderBarChart(filtered);
            renderDoughnutChart(filtered);
        }

        /* â”€â”€â”€â”€â”€ KPI Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function renderKPIs(rows) {
            const totalSpend = rows.reduce((s, r) => s + r.cost, 0);
            const totalClicks = rows.reduce((s, r) => s + r.clicks, 0);
            const totalConv = rows.reduce((s, r) => s + r.conversions, 0);
            const avgCpc = totalClicks > 0 ? totalSpend / totalClicks : 0;

            const kpis = [
                { label: 'Total Spend', value: fmtC(totalSpend) },
                { label: 'Total Clicks', value: fmt(totalClicks) },
                { label: 'Conversions', value: totalConv.toFixed(1) },
                { label: 'Avg. CPC', value: fmtC(avgCpc) },
            ];

            const grid = document.getElementById('kpiGrid');
            grid.innerHTML = '';
            kpis.forEach((k, i) => {
                grid.innerHTML += `
      <div class="kpi-card fade-up delay-${i + 1}">
        <div class="kpi-label">${k.label}</div>
        <div class="kpi-value">${k.value}</div>
        <div class="kpi-sub"><span class="live-dot"></span> Live data</div>
      </div>`;
            });
        }

        /* â”€â”€â”€â”€â”€ Campaign Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function renderTable(rows) {
            const enriched = rows.map(r => ({
                ...r,
                ctr: r.impressions > 0 ? (r.clicks / r.impressions) * 100 : 0,
                cpc: r.clicks > 0 ? r.cost / r.clicks : 0,
                costConv: r.conversions > 0 ? r.cost / r.conversions : 0,
            }));

            enriched.sort((a, b) => {
                let va = a[sortKey], vb = b[sortKey];
                if (typeof va === 'string') { va = va.toLowerCase(); vb = vb.toLowerCase(); }
                if (va < vb) return -1 * sortDir;
                if (va > vb) return 1 * sortDir;
                return 0;
            });

            document.querySelectorAll('thead th').forEach(th => {
                const arrow = th.querySelector('.sort-arrow');
                if (!arrow) return;
                if (th.dataset.sort === sortKey) {
                    arrow.textContent = sortDir === -1 ? ' â–¼' : ' â–²';
                } else {
                    arrow.textContent = '';
                }
            });

            const tbody = document.getElementById('campaignBody');
            if (enriched.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text-secondary)">No campaigns with spend found for this filter.</td></tr>`;
                return;
            }

            tbody.innerHTML = enriched.map(c => `
    <tr>
      <td class="campaign-name">${c.campaign_name}<span class="account-tag">${c.customer_name}</span></td>
      <td><span class="status-badge ${statusClass(c.campaign_status)}">${c.campaign_status.toLowerCase()}</span></td>
      <td><span class="channel-badge">${c.channel_type.replace(/_/g, ' ')}</span></td>
      <td>${fmtC(c.cost)}</td>
      <td>${fmt(c.impressions)}</td>
      <td>${fmt(c.clicks)}</td>
      <td>${c.ctr.toFixed(2)}%</td>
      <td>${fmtC(c.cpc)}</td>
      <td>${c.conversions.toFixed(1)}</td>
      <td>${c.conversions > 0 ? fmtC(c.costConv) : 'â€”'}</td>
    </tr>`).join('');
        }

        /* â”€â”€â”€â”€â”€ Bar Chart: Spend by Account â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function renderBarChart(rows) {
            const accountSpend = {};
            const accountClicks = {};
            const accountConv = {};
            rows.forEach(r => {
                accountSpend[r.customer_name] = (accountSpend[r.customer_name] || 0) + r.cost;
                accountClicks[r.customer_name] = (accountClicks[r.customer_name] || 0) + r.clicks;
                accountConv[r.customer_name] = (accountConv[r.customer_name] || 0) + r.conversions;
            });

            const labels = Object.keys(accountSpend).sort();
            const spendData = labels.map(l => accountSpend[l]);
            const clickData = labels.map(l => accountClicks[l]);
            const convData = labels.map(l => accountConv[l]);

            const ctx = document.getElementById('barChart').getContext('2d');

            if (barChartInstance) barChartInstance.destroy();

            barChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Spend (â‚ª)',
                            data: spendData,
                            backgroundColor: ['#3b82f6', '#06b6d4', '#10b981', '#f59e0b', '#f43f5e', '#8b5cf6'],
                            borderRadius: 8,
                            barPercentage: .5,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Clicks',
                            data: clickData,
                            backgroundColor: 'rgba(139,92,246,.35)',
                            borderColor: '#8b5cf6',
                            borderWidth: 2,
                            borderRadius: 8,
                            barPercentage: .5,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Conversions',
                            data: convData,
                            backgroundColor: 'rgba(16,185,129,.35)',
                            borderColor: '#10b981',
                            borderWidth: 2,
                            borderRadius: 8,
                            barPercentage: .5,
                            yAxisID: 'y2'
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { labels: { color: '#64748b', font: { family: 'Inter', size: 12 }, boxWidth: 12, padding: 20 } },
                        tooltip: { backgroundColor: '#ffffff', titleColor: '#1e293b', bodyColor: '#475569', borderColor: 'rgba(0,0,0,.08)', borderWidth: 1, padding: 12, cornerRadius: 10 }
                    },
                    scales: {
                        x: { grid: { color: 'rgba(0,0,0,.04)' }, ticks: { color: '#64748b', font: { size: 11 } } },
                        y: { position: 'left', grid: { color: 'rgba(0,0,0,.04)' }, ticks: { color: '#64748b', font: { size: 11 }, callback: v => 'â‚ª' + v.toLocaleString() } },
                        y1: { position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#64748b', font: { size: 11 } } },
                        y2: { position: 'right', grid: { drawOnChartArea: false }, ticks: { color: '#64748b', font: { size: 11 } }, side: 'right' }
                    },
                    animation: { duration: 1000, easing: 'easeOutQuart' }
                }
            });
        }

        /* â”€â”€â”€â”€â”€ Doughnut Chart: Spend by Campaign â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function renderDoughnutChart(rows) {
            const sorted = [...rows].sort((a, b) => b.cost - a.cost);
            const top = sorted.slice(0, 8);
            const otherCost = sorted.slice(8).reduce((s, r) => s + r.cost, 0);

            const labels = top.map(r => r.campaign_name.length > 28 ? r.campaign_name.slice(0, 26) + 'â€¦' : r.campaign_name);
            const data = top.map(r => r.cost);
            if (otherCost > 0) { labels.push('Other'); data.push(otherCost); }

            const palette = ['#3b82f6', '#06b6d4', '#10b981', '#f59e0b', '#f43f5e', '#8b5cf6', '#ec4899', '#14b8a6', '#64748b'];

            const ctx = document.getElementById('doughnutChart').getContext('2d');
            if (doughnutChartInstance) doughnutChartInstance.destroy();

            doughnutChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{ data, backgroundColor: palette, borderColor: '#ffffff', borderWidth: 3, hoverOffset: 8 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    cutout: '68%',
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#64748b', font: { family: 'Inter', size: 10 }, padding: 10, boxWidth: 10 } },
                        tooltip: {
                            backgroundColor: '#ffffff', titleColor: '#1e293b', bodyColor: '#475569',
                            borderColor: 'rgba(0,0,0,.08)', borderWidth: 1, padding: 12, cornerRadius: 10,
                            callbacks: { label: ctx => ` ${ctx.label}: ${fmtC(ctx.parsed)}` }
                        }
                    },
                    animation: { animateRotate: true, duration: 1200, easing: 'easeOutQuart' }
                }
            });
        }

        /* â”€â”€â”€â”€â”€ Event: Account filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        document.getElementById('accountFilter').addEventListener('change', (e) => {
            currentAccount = e.target.value;
            render();
        });

        /* â”€â”€â”€â”€â”€ Event: Table sort â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        document.querySelectorAll('thead th[data-sort]').forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.sort;
                if (sortKey === key) {
                    sortDir *= -1;
                } else {
                    sortKey = key;
                    sortDir = -1;
                }
                const filtered = currentAccount === 'all'
                    ? activeCampaigns
                    : activeCampaigns.filter(r => r.customer_name === currentAccount);
                renderTable(filtered);
            });
        });

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           AI CHAT FUNCTIONALITY
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        function getTimeString() {
            return new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }

        /* â”€â”€ Simple Markdown â†’ HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function renderMarkdown(text) {
            // Code blocks
            text = text.replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) => {
                return `<pre><code>${escapeHtml(code.trim())}</code></pre>`;
            });
            // Inline code
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            // Bold
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            // Italic
            text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
            // Unordered lists
            text = text.replace(/^[-*] (.+)$/gm, '<li>$1</li>');
            text = text.replace(/(<li>[\s\S]*?<\/li>)/g, '<ul>$1</ul>');
            // Fix nested ul
            text = text.replace(/<\/ul>\s*<ul>/g, '');
            // Ordered lists
            text = text.replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
            // Line breaks â†’ paragraphs
            text = text.replace(/\n\n/g, '</p><p>');
            text = text.replace(/\n/g, '<br>');
            if (!text.startsWith('<')) text = '<p>' + text + '</p>';
            return text;
        }

        function escapeHtml(str) {
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        /* â”€â”€ Add message to chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function addMessage(role, content) {
            const welcome = document.getElementById('chatWelcome');
            if (welcome) welcome.remove();

            const messages = document.getElementById('chatMessages');
            const isUser = role === 'user';
            const time = getTimeString();

            const msgDiv = document.createElement('div');
            msgDiv.className = `msg ${isUser ? 'user' : 'ai'}`;

            const avatarContent = isUser ? 'ğŸ‘¤' : 'ğŸ¤–';
            const bubbleContent = isUser ? escapeHtml(content) : renderMarkdown(content);

            msgDiv.innerHTML = `
                <div class="msg-avatar">${avatarContent}</div>
                <div>
                    <div class="msg-bubble">${bubbleContent}</div>
                    <div class="msg-time">${time}</div>
                </div>
            `;

            messages.appendChild(msgDiv);
            // Scroll so the top of the new message is visible
            if (!isUser) {
                msgDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                messages.scrollTop = messages.scrollHeight;
            }
        }

        /* â”€â”€ Switch Chat Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function switchChatTab(tabId) {
            activeChatTab = tabId;

            // Reset UI state for the new tab
            showTyping(tabSending[tabId]);
            updateSendButton();

            // Update container theme class
            const container = document.getElementById('chatPageContainer');
            container.className = `chat-page theme-${tabId}`;

            // Update tab styling
            document.querySelectorAll('.chat-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeTabBtn = document.querySelector(`.chat-tab-btn[onclick="switchChatTab('${tabId}')"]`);
            activeTabBtn.classList.add('active');

            // Remove unread badge if present
            const badge = activeTabBtn.querySelector('.unread-badge');
            if (badge) badge.remove();

            // Clear messages area
            const messages = document.getElementById('chatMessages');
            messages.innerHTML = '';

            // Render existing history or welcome message
            const history = chatHistories[tabId];
            if (history.length === 0) {
                // Determine company name for the welcome message
                let companyName = "Euroline";
                if (tabId === 'tab2') companyName = "Floor&Care";
                if (tabId === 'tab3') companyName = "Marshanski Build";

                messages.innerHTML = `
                    <div class="chat-welcome" id="chatWelcome">
                        <div class="chat-welcome-icon">ğŸ¤–</div>
                        <h3>×¦'××˜ ×¢× Claude AI - ${companyName}</h3>
                        <p>×©××œ×• ××•×ª×™ ×›×œ ×“×‘×¨ ×¢×œ ×§××¤×™×™× ×™× ×©×™×•×•×§×™×™×, ××¡×˜×¨×˜×’×™×™×ª ×¤×¨×¡×•×, × ×™×ª×•×— ×‘×™×¦×•×¢×™× ××• ×¨×¢×™×•× ×•×ª ×œ×¦××™×—×” ×¢×‘×•×¨ ${companyName}. ×× ×™ ×›××Ÿ ×œ×¢×–×•×¨!</p>
                        <div class="chat-suggestions">
                            <button class="chat-suggestion-btn" onclick="useSuggestion('× ×ª×— ××ª ×‘×™×¦×•×¢×™ ×”×¤×¨×¡×•× ×©×œ×™')">ğŸ“ˆ × ×™×ª×•×— ×‘×™×¦×•×¢×™ ×¤×¨×¡×•×</button>
                            <button class="chat-suggestion-btn" onclick="useSuggestion('×”×¦×¢ ××¡×˜×¨×˜×’×™×•×ª ×œ××•×¤×˜×™××™×–×¦×™×” ×©×œ ×ª×§×¦×™×‘')">ğŸ’° ××•×¤×˜×™××™×–×¦×™×™×ª ×ª×§×¦×™×‘</button>
                            <button class="chat-suggestion-btn" onclick="useSuggestion('×›×ª×•×‘ ×œ×™ ×§×•×¤×™ ×¤×¨×¡×•××™ ××©×›× ×¢ ×œ×§××¤×™×™×Ÿ ×œ×™×“×™×')">âœï¸ ×›×ª×™×‘×ª ×§×•×¤×™</button>
                            <button class="chat-suggestion-btn" onclick="useSuggestion('××”×Ÿ ×©×™×˜×•×ª ×”×¢×‘×•×“×” ×”××•××œ×¦×•×ª ×‘×’×•×’×œ ××“×¡ ×‘-2026?')">ğŸš€ ×©×™×˜×•×ª ××•××œ×¦×•×ª</button>
                        </div>
                    </div>`;
            } else {
                // Re-render chat history
                history.forEach(msg => {
                    const isUser = msg.role === 'user';
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `msg ${isUser ? 'user' : 'ai'}`;
                    const avatarContent = isUser ? 'ğŸ‘¤' : 'ğŸ¤–';
                    const bubbleContent = isUser ? escapeHtml(msg.content) : renderMarkdown(msg.content);

                    // We don't have stored timestamps per message in this simple state, so we just use empty string
                    msgDiv.innerHTML = `
                        <div class="msg-avatar">${avatarContent}</div>
                        <div>
                            <div class="msg-bubble">${bubbleContent}</div>
                            <div class="msg-time"></div>
                        </div>
                    `;
                    messages.appendChild(msgDiv);
                });
                // Scroll to the top of the last message with spacing
                const lastMsg = messages.lastElementChild;
                if (lastMsg) {
                    lastMsg.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }

        /* â”€â”€ Typing indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function showTyping(show) {
            const indicator = document.getElementById('typingIndicator');
            if (show) {
                indicator.classList.add('visible');
                document.getElementById('chatMessages').scrollTop =
                    document.getElementById('chatMessages').scrollHeight;
            } else {
                indicator.classList.remove('visible');
            }
        }

        /* â”€â”€ Send message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        // Per-tab sending state so tabs are fully independent
        let tabSending = { 'tab1': false, 'tab2': false, 'tab3': false };

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            // Capture everything for the current tab at the moment of sending
            const tabAtSend = activeChatTab;
            console.log('[AI Chat] sendChatMessage called, tab:', tabAtSend, 'message:', message.substring(0, 50));

            // Don't allow double-send on the SAME tab, but allow other tabs
            if (tabSending[tabAtSend]) return;
            tabSending[tabAtSend] = true;

            // Show user message on the current DOM (we ARE on this tab right now)
            addMessage('user', message);
            chatHistories[tabAtSend].push({ role: 'user', content: message });
            input.value = '';
            input.style.height = 'auto';

            // Show typing indicator & disable send (only affects current visible tab)
            showTyping(true);
            updateSendButton();

            // Freeze the payload data from this tab
            const payload = {
                message: message,
                conversation_id: chatConversationIds[tabAtSend],
                google_ads_customer_ids: [chatGoogleAdsIds[tabAtSend]],
                include_google_ads: true,
                ga_property_id: chatProperties[tabAtSend],
                gsc_property_url: chatGscUrls[tabAtSend],
                gtm_account_id: chatGtmAccountIds[tabAtSend],
                gtm_public_id: chatGtmPublicIds[tabAtSend]
            };
            const fetchUrl = `${API_BASE}/ai-chat`;
            console.log('[AI Chat] Fetch URL:', fetchUrl);
            console.log('[AI Chat] Sending payload:', JSON.stringify(payload));

            try {
                let lastError = null;
                let data = null;
                const maxAttempts = 2;
                const retryDelay = 5000;
                for (let attempt = 0; attempt < maxAttempts; attempt++) {
                    try {
                        console.log(`[AI Chat] [${tabAtSend}] Attempt ${attempt + 1}/${maxAttempts} - fetching...`);
                        const startTime = Date.now();
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 300000);
                        const res = await fetch(fetchUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload),
                            mode: 'cors',
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
                        console.log(`[AI Chat] [${tabAtSend}] Response received in ${elapsed}s - status: ${res.status}`);
                        if (!res.ok) {
                            const errBody = await res.text().catch(() => '');
                            throw new Error(`HTTP ${res.status}: ${errBody.substring(0, 200)}`);
                        }
                        data = await res.json();
                        console.log(`[AI Chat] [${tabAtSend}] Response data ok:`, data.ok);
                        break;
                    } catch (e) {
                        console.error(`[AI Chat] [${tabAtSend}] Attempt ${attempt + 1} failed:`, e.message);
                        lastError = e;
                        if (attempt < maxAttempts - 1) {
                            console.log(`[AI Chat] [${tabAtSend}] Retrying in ${retryDelay / 1000}s...`);
                            await new Promise(r => setTimeout(r, retryDelay));
                        }
                    }
                }
                if (!data) throw lastError;

                const reply = data.response || data.reply || data.message || 'No response received.';
                console.log(`[AI Chat] [${tabAtSend}] Reply length:`, reply.length);

                // Always save to the correct tab's history
                chatHistories[tabAtSend].push({ role: 'assistant', content: reply });

                // Only update DOM if user is still on the same tab
                if (activeChatTab === tabAtSend) {
                    showTyping(false);
                    addMessage('ai', reply);
                    console.log(`[AI Chat] [${tabAtSend}] Message added to DOM (user on same tab)`);
                } else {
                    console.log(`[AI Chat] [${tabAtSend}] Response saved to history (user switched to ${activeChatTab})`);

                    // Add unread badge to the background tab
                    const tabBtn = document.querySelector(`.chat-tab-btn[onclick="switchChatTab('${tabAtSend}')"]`);
                    if (tabBtn && !tabBtn.querySelector('.unread-badge')) {
                        const badge = document.createElement('div');
                        badge.className = 'unread-badge';
                        badge.textContent = '1';
                        tabBtn.appendChild(badge);
                    }
                }

            } catch (err) {
                console.error(`[AI Chat] [${tabAtSend}] Final error:`, err.message);
                const isTimeout = err.name === 'AbortError';
                const errorMsg = isTimeout
                    ? 'âš ï¸ **Error:** The request took too long. The server may be restarting. Please try again.'
                    : `âš ï¸ **Error:** Could not reach the AI service. ${err.message}`;

                // Save error to history
                chatHistories[tabAtSend].push({ role: 'assistant', content: errorMsg });

                // Only update DOM if user is still on the same tab
                if (activeChatTab === tabAtSend) {
                    showTyping(false);
                    addMessage('ai', errorMsg);
                } else {
                    console.log(`[AI Chat] [${tabAtSend}] Error saved to history (user switched to ${activeChatTab})`);

                    // Add unread badge to the background tab to notify user of failure
                    const tabBtn = document.querySelector(`.chat-tab-btn[onclick="switchChatTab('${tabAtSend}')"]`);
                    if (tabBtn && !tabBtn.querySelector('.unread-badge')) {
                        const badge = document.createElement('div');
                        badge.className = 'unread-badge';
                        badge.textContent = '!';
                        badge.style.backgroundColor = '#ef4444'; // Red badge for errors
                        tabBtn.appendChild(badge);
                    }
                }
            }

            tabSending[tabAtSend] = false;
            updateSendButton();
            if (activeChatTab === tabAtSend) {
                input.focus();
            }
        }

        /* â”€â”€ Update send button based on active tab's state â”€â”€ */
        function updateSendButton() {
            const sendBtn = document.getElementById('chatSendBtn');
            sendBtn.disabled = tabSending[activeChatTab];
        }

        /* â”€â”€ Keyboard handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function handleChatKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatMessage();
            }
        }

        /* â”€â”€ Auto-grow textarea â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        document.getElementById('chatInput').addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 140) + 'px';
        });

        /* â”€â”€ Suggestion buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        function useSuggestion(text) {
            document.getElementById('chatInput').value = text;
            sendChatMessage();
        }

        /* â”€â”€â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        fetchData();
        switchChatTab('tab1'); // Initialize the first tab
    </script>

</body>

</html>